# MDEC

MDEC используется для декодирования потокового видео, обычно записанного в .STR файлы. Но в общем случае MDEC может декодировать любые изображения (картинки, текстуры и пр.)

Алгоритм декодирования несложный и практически повторяет JPEG. Поэтому разжевывать основы и принципы DCT мы тут не будем.

Входные данные разбиваются на более мелкие порции, называемые макроблоками. Поэтому процесс декодирования производится "шагами", декодируя макроблоки по очереди.

Аппаратно MDEC производит декодирование RLE, IDCT и конверсию color-space (YCbCr -> RGB). VLC-декодирование (Хаффман) производится программно, библиотекой PsyQ SDK (слишком жирно было бы Хаффмана железом делать).

## Программный интерфейс

Программисту доступны 2 регистра: MDEC Data/Command (0x1f80_1820) и MDEC Status/Control (0x1f80_1824), а также 2 DMA-канала MDEC Input (DMA0) и MDEC Output (DMA1).

Более подробно можно почитать у Мартина: http://nocash.emubase.de/psx-spx.htm#macroblockdecodermdec

В PsqQ SDK содержится специальная библиотека libpress, которая содержит в себе все основные API для декодирования потока данных MDEC.

## Форматы данных

Формат `входных` данных битстрима зависит от режима `выходных` данных:
- Если формат выходных данных установлен в 4bpp или 8bpp (монохром), то MDEC интерпретирует входные данные как 8x8 блоки яркости (Y)
- Если формат выходных данных установлен в 15bpp или 24bpp (цвет), то входные данные интерпретируются тоже блоками 8x8, но в такой последовательности : Cr, Cb, Y1, Y2, Y3, Y4. При этом блоки цветности "растягиваются" до блоков 16x16 (при адресации индекс просто умножается на 2).

<pre>
   .-----.       .-----.       .-----.
   |     |       |     |       |Y1|Y2|
   | Cr  |   +   | Cb  |   +   |--+--|
   |     |       |     |       |Y3|Y4|
   '-----'       '-----'       '-----'
</pre>

Цветность растягивается по причине того, что беспонту хранить отдельные блоки, потому что глаз человека все равно не заметит разницы.

Формат выходных данных устанавливается контрольным регистром MDEC.

## MDEC Circuit

- RLE Decoding
- Uses Radix-4 Booth multiplication: http://www.geoffknagge.com/fyp/booth.shtml
- Схема [[MDEC]] IDCT. Перемножает результат RLE декодирования и Scale Table Matrix (за 2 прохода).

### Топология

![Circuit002_loc](/imgstore/mdec/Circuit002_loc.jpg)

![Circuit002_topo](/imgstore/mdec/Circuit002_topo.jpg)

![Circuit002_topo2](/imgstore/mdec/Circuit002_topo2.jpg)

![Circuit002_topo3](/imgstore/mdec/Circuit002_topo3.jpg)

### Логическая схема

Схема представляет собой IDCT преобразование являющегося частью MDEC декомпрессии.

Преобразование осуществляется за 2 прохода:

#### Pass 1

На первом проходе осуществляется умножение результата RLE декомпрессии и Scale Table Matrix хранящейся в UNIT 00. Она хранится в виде 32 записей по 26 бит. После выхода данные попарно поступают на мультиплексоры где выбирается какие 13 бит использовать.

![Circuit002_logic](/imgstore/mdec/Circuit002_logic.jpg)

Входы:
 - RLE вход: 12 бит
 - Scale Table Matrix вход: 13 бит
 - Сумма предыдущего этапа вычисления: 17 бит

Схема сразу умножает 2 входа и суммирует умножение с результатом предыдущего шага вычисления. 17 бит результата вновь подается на схему.

В конце вычисления старшие 13 бит результата сохраняются в UNIT 01, который представляет из себя двухпортовую память. то есть на вход и выход которой могут подаваться разные значения.

#### Pass 2

На втором проходе перемножается уже 13 бит результата первого прохода и 12 верхних бит Scale Table Matrix.

![Circuit002_logic2](/imgstore/mdec/Circuit002_logic2.jpg)

Входы:
 - Результат первого прохода: 13 бит
 - Scale Table Matrix вход: верхние 12 бит
 - Сумма предыдущего этапа вычисления: 17 бит

Схема вновь умножает 2 входа и суммирует умножение с результатом предыдущего шага вычисления. 17 бит результата вновь подается на схему.

#### Деление на 2

В конце вычисления старшие 10 бит результата передаются на схему знакового деления на 2 с клампингом -128, 127. На выходе мы получаем 8 бит со знаком.

![Circuit002_logic3](/imgstore/mdec/Circuit002_logic3.jpg)

![002_conv](/imgstore/mdec/002_conv.png)

#### Управление IDCT

Тут есть 3 независимых счетчика с которых идут контрольные выходы, объединяемые различными логическими операндами. Выходные линии управляют клоками триггеров в первом и втором пассах а также адресными линиями первого и нулевого юнитов.

![Circuit002_logic4](/imgstore/mdec/Circuit002_logic4.jpg)
